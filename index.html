<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentforce MIAW Preview</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }

        /* --- STILE PULSANTE PERSONALIZZATO --- */
        .custom-chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #005290; /* Tuo colore aziendale */
            color: white;
            border: none;
            border-radius: 50px;
            padding: 8px 20px 8px 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 82, 144, 0.3);
            transition: all 0.3s ease;
            font-size: 15px;
            font-weight: 600;
            z-index: 9999;
        }

        .custom-chat-button:hover {
            background-color: #003d6b;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 82, 144, 0.4);
        }

        .custom-chat-button-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .custom-chat-button-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* --- NASCONDI IL PULSANTE STANDARD DI SALESFORCE --- */
        /* Questo tenta di nascondere il pulsante nativo rotondo che Salesforce inietta */
        .embeddedMessagingConversationButtonWrapper,
        [class*='embeddedMessagingConversationButton'],
        iframe[title="Chat Button"] {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

    </style>
</head>
<body>

    <img src="bobbio_logo.png" alt="Logo" style="max-width: 200px; margin-bottom: 20px;" onerror="this.style.display='none'">
    <h2>Test Agentforce (MIAW)</h2>

    <button id="customChatButton" class="custom-chat-button" onclick="launchCustomChat()">
        <div class="custom-chat-button-icon">
            <img src="https://pianidibobbio.file.force.com/sfc/dist/version/renditionDownload?rendition=ORIGINAL_Jpg&versionId=068KB000006Bg5z&operationContext=DELIVERY&contentId=05TKB00000cW6Zd&page=0&d=/a/KB000000oQmX/rf61g94muITSDNRmmLNR7mVLk8Bq0k3Y1gXLZ_jPoAY&oid=00DKB0000014aXF&dpt=null&viewId=" alt="Chat">
        </div>
        <span id="chatButtonText">Caricamento...</span>
    </button>

    <script type='text/javascript'>
        // 1. Rilevamento Lingua
        function detectLanguage() {
            const url = window.location.href;
            if (url.indexOf('/en/') > -1) {
                return 'en_US'; // Salesforce preferisce en_US
            }
            return 'it'; // Default
        }

        const currentLang = detectLanguage();

        // 2. Imposta Testo Pulsante Immediatamente
        const btnText = document.getElementById('chatButtonText');
        if (currentLang === 'en_US') {
            btnText.innerText = "Need help?";
        } else {
            btnText.innerText = "Serve aiuto?";
        }

        // 3. Funzione di Inizializzazione Salesforce (MODIFICATA per usare currentLang)
        function initEmbeddedMessaging() {
            try {
                // Impostiamo la lingua dinamicamente
                embeddedservice_bootstrap.settings.language = currentLang; 

                embeddedservice_bootstrap.init(
                    '00DKB0000014aXF',
                    'Web_test',
                    'https://pianidibobbio.my.site.com/ESWWebtest1763410614711',
                    {
                        scrt2URL: 'https://pianidibobbio.my.salesforce-scrt.com'
                    }
                );
            } catch (err) {
                console.error('Error loading Embedded Messaging: ', err);
            }
        };

        // 4. Funzione per Lanciare la Chat dal Pulsante Custom
        function launchCustomChat() {
            console.log("Tentativo avvio chat...");
            try {
                // Nuova API per MIAW (Bootstrap)
                embeddedservice_bootstrap.utilAPI.launchChat()
                    .then(() => {
                        console.log("Chat avviata con successo");
                    })
                    .catch((e) => {
                        console.error("Errore avvio chat:", e);
                        // Fallback se l'utente clicca prima che sia pronto
                        alert("La chat si sta caricando, riprova tra un istante.");
                    });
            } catch (e) {
                console.error("API non pronta:", e);
                alert("Attendere il caricamento della chat...");
            }
        }
    </script>

    <script type='text/javascript' src='https://pianidibobbio.my.site.com/ESWWebtest1763410614711/assets/js/bootstrap.min.js' onload='initEmbeddedMessaging()'></script>

</body>
</html>
